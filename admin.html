<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - The All Game</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,sans-serif}
        body{background:#1a1a2e;color:#fff;min-height:100vh;padding:15px}
        
        .admin-container{max-width:1400px;margin:auto}
        
        /* Login Form */
        .admin-login{
            background:#1e1e2e;border-radius:12px;padding:25px;
            max-width:380px;margin:40px auto;border:2px solid #00ff88;
            box-shadow:0 5px 20px rgba(0,0,0,0.5)
        }
        .admin-login h2{color:#00ff88;margin-bottom:15px;text-align:center}
        .admin-login input{
            width:100%;padding:12px;margin:8px 0;border-radius:8px;
            background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);
            color:#fff;font-size:14px
        }
        .admin-login button{
            width:100%;padding:12px;background:linear-gradient(135deg,#ff3333,#cc0000);
            color:#fff;border:none;border-radius:8px;font-weight:bold;cursor:pointer;
            margin-top:10px;transition:0.2s
        }
        .admin-login button:hover{transform:translateY(-2px)}
        
        /* Admin Panel */
        #adminPanel{display:none}
        .admin-header{
            background:rgba(0,0,0,0.4);border-radius:12px;padding:20px;
            margin-bottom:20px;border:2px solid #ff3333;text-align:center
        }
        .admin-header h1{color:#ff3333;font-size:1.8em;margin-bottom:5px}
        
        /* Tombol Logout & Kembali */
        .top-buttons{
            position:fixed;top:15px;right:15px;display:flex;gap:10px;z-index:100
        }
        .top-btn{
            padding:8px 15px;border:none;border-radius:6px;
            cursor:pointer;font-weight:bold;font-size:13px
        }
        .logout-btn{background:#ff3333;color:#fff}
        .back-btn{background:#00ff88;color:#1a1a2e}
        .refresh-btn{background:#2196F3;color:#fff}
        
        /* Tab Navigation */
        .tabs{
            display:flex;gap:5px;margin-bottom:20px;flex-wrap:wrap;
            background:rgba(0,0,0,0.3);padding:5px;border-radius:8px
        }
        .tab-btn{
            padding:10px 20px;background:rgba(255,255,255,0.1);
            border:none;border-radius:6px;color:#aaa;cursor:pointer;
            font-weight:bold;transition:0.3s;flex:1;min-width:120px
        }
        .tab-btn.active{
            background:#00ff88;color:#1a1a2e;box-shadow:0 0 10px rgba(0,255,136,0.3)
        }
        .tab-btn:hover:not(.active){background:rgba(255,255,255,0.2)}
        
        /* Tab Content */
        .tab-content{display:none}
        .tab-content.active{display:block;animation:fadeIn 0.5s}
        
        @keyframes fadeIn{from{opacity:0} to{opacity:1}}
        
        /* Stats */
        .stats-grid{
            display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
            gap:15px;margin-bottom:20px
        }
        .stat-card{
            background:rgba(0,0,0,0.3);padding:15px;border-radius:10px;
            text-align:center;border:2px solid #00ff88
        }
        .stat-card h3{color:#00ff88;margin-bottom:8px;font-size:14px}
        .stat-card .number{font-size:1.5em;font-weight:bold}
        
        /* Search */
        .search-box{margin:15px 0;display:flex;gap:8px}
        .search-box input{
            flex:1;padding:10px;background:rgba(255,255,255,0.1);
            border:1px solid rgba(255,255,255,0.2);color:#fff;border-radius:6px
        }
        .search-box button{
            padding:10px 15px;background:#00ff88;color:#1a1a2e;
            border:none;border-radius:6px;font-weight:bold;cursor:pointer
        }
        .search-box .reset-btn{background:#666;color:#fff}
        
        /* Table */
        .users-table-container{
            background:#1e1e2e;border-radius:12px;padding:15px;
            margin-top:15px;overflow-x:auto
        }
        table{width:100%;border-collapse:collapse;font-size:13px}
        th,td{padding:10px 12px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.1)}
        th{background:rgba(0,0,0,0.3);color:#00ff88}
        tr:hover{background:rgba(255,255,255,0.05)}
        
        /* Status Badge */
        .status-badge{
            padding:4px 8px;border-radius:4px;font-size:11px;font-weight:bold
        }
        .online-badge{background:rgba(0,255,136,0.2);color:#00ff88}
        .offline-badge{background:rgba(255,51,51,0.2);color:#ff3333}
        .banned-badge{background:rgba(255,0,0,0.2);color:#ff0000}
        
        /* Action Buttons */
        .user-action-btn{
            padding:5px 10px;border:none;border-radius:4px;cursor:pointer;
            margin:2px;font-size:11px;font-weight:bold;transition:0.2s
        }
        .user-action-btn:hover{opacity:0.9;transform:translateY(-1px)}
        .edit-btn{background:#4CAF50;color:#fff}
        .ban-btn{background:#f44336;color:#fff}
        .unban-btn{background:#2196F3;color:#fff}
        .give-btn{background:#FF9800;color:#fff}
        .delete-btn{background:#9C27B0;color:#fff}
        .view-btn{background:#2196F3;color:#fff}
        .kick-btn{background:#FF5722;color:#fff}
        
        /* Device Info Modal */
        .device-modal{
            position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,0.95);display:none;justify-content:center;
            align-items:center;z-index:1000;padding:20px
        }
        .device-modal.active{display:flex}
        .device-content{
            background:#1e1e2e;border-radius:15px;padding:25px;
            border:3px solid #00ff88;max-width:800px;width:100%;
            max-height:90vh;overflow-y:auto
        }
        .device-header{
            display:flex;justify-content:space-between;align-items:center;
            margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid rgba(255,255,255,0.1)
        }
        .device-header h3{
            color:#00ff88;font-size:1.5em;margin:0
        }
        .close-modal{
            background:#ff3333;color:#fff;border:none;border-radius:50%;
            width:35px;height:35px;font-size:20px;cursor:pointer;
            display:flex;align-items:center;justify-content:center
        }
        
        /* Device Info Grid */
        .device-grid{
            display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
            gap:15px;margin-top:20px
        }
        .info-card{
            background:rgba(0,0,0,0.3);border-radius:10px;padding:15px;
            border-left:4px solid #00ff88
        }
        .info-card h4{
            color:#00ff88;margin-bottom:10px;font-size:14px;
            display:flex;align-items:center;gap:8px
        }
        .info-value{
            font-size:16px;font-weight:bold;word-break:break-all
        }
        .info-detail{
            font-size:12px;color:#aaa;margin-top:5px
        }
        
        /* Modal untuk Edit User */
        .action-modal{
            position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,0.9);display:none;justify-content:center;
            align-items:center;z-index:1000
        }
        .action-modal.active{display:flex}
        .modal-content{
            background:#1e1e2e;padding:20px;border-radius:12px;
            border:2px solid #00ff88;max-width:450px;width:90%
        }
        .modal-content h3{color:#00ff88;margin-bottom:10px}
        .modal-content input{
            width:100%;padding:10px;margin:5px 0;background:rgba(255,255,255,0.1);
            border:1px solid rgba(255,255,255,0.2);color:#fff;border-radius:6px
        }
        .modal-buttons{display:flex;gap:8px;margin-top:15px}
        .modal-buttons button{flex:1;padding:10px;border:none;border-radius:6px;cursor:pointer;font-weight:bold}
        .save-btn{background:#4CAF50;color:#fff}
        .cancel-btn{background:#f44336;color:#fff}
        .confirm-btn{background:#9C27B0;color:#fff}
        
        /* Messages */
        .message{
            position:fixed;top:15px;right:15px;padding:12px 18px;
            border-radius:6px;color:#fff;font-weight:bold;z-index:1001;
            animation:slideIn 0.3s ease
        }
        .success{background:linear-gradient(135deg,#00ff88,#00cc6a)}
        .error{background:linear-gradient(135deg,#ff3333,#cc0000)}
        .warning{background:linear-gradient(135deg,#FF9800,#F57C00)}
        
        @keyframes slideIn{
            from{transform:translateX(100%);opacity:0}
            to{transform:translateX(0);opacity:1}
        }
        
        /* Responsive */
        @media (max-width:768px){
            .stats-grid{grid-template-columns:1fr 1fr}
            .top-buttons{flex-direction:column;gap:5px}
            .top-btn{font-size:11px;padding:6px 10px}
            table{font-size:12px}
            th,td{padding:8px 10px}
            .tabs{flex-direction:column}
            .tab-btn{width:100%}
            .device-grid{grid-template-columns:1fr}
        }
    </style>
</head>
<body>
    <!-- Admin Login Form -->
    <div id="loginForm" class="admin-login" style="display: none;">
        <h2>üîê Fitur Premium - Login</h2>
        <input type="text" id="adminUsername" placeholder="Username" value="">
        <input type="password" id="adminPassword" placeholder="Password" value="">
        <button onclick="adminLogin()">LOGIN</button>
    </div>
    
    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-container" style="display: none;">
        <!-- Tombol Logout & Kembali -->
        <div class="top-buttons">
            <button class="top-btn back-btn" onclick="goBack()">‚Üê BACK</button>
            <button class="top-btn refresh-btn" onclick="refreshAllData()">üîÑ REFRESH</button>
            <button class="top-btn logout-btn" onclick="adminLogout()">LOGOUT</button>
        </div>
        
        <div class="admin-header">
            <h1>üëë Fitur Premium</h1>
            <p>Selamat datang, <span id="adminName"></span>! | <span id="lastUpdate">Loading...</span></p>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('users')">üë• USER MANAGEMENT</button>
            <button class="tab-btn" onclick="switchTab('devices')">üì± DEVICE MONITOR</button>
            <button class="tab-btn" onclick="switchTab('online')">üü¢ ONLINE USERS</button>
        </div>
        
        <!-- Tab 1: User Management -->
        <div id="usersTab" class="tab-content active">
            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Users</h3>
                    <div class="number" id="totalUsers">0</div>
                </div>
                <div class="stat-card">
                    <h3>Online Now</h3>
                    <div class="number" id="onlineUsers">0</div>
                </div>
                <div class="stat-card">
                    <h3>Playing Games</h3>
                    <div class="number" id="playingUsers">0</div>
                </div>
                <div class="stat-card">
                    <h3>Banned Users</h3>
                    <div class="number" id="bannedUsers">0</div>
                </div>
            </div>
            
            <!-- Search Box -->
            <div class="search-box">
                <input type="text" id="searchUser" placeholder="Cari username atau UID...">
                <button onclick="searchUser()">Cari</button>
                <button onclick="clearSearch()" class="reset-btn">Reset</button>
            </div>
            
            <!-- Users Table -->
            <div class="users-table-container">
                <h2>üìã DAFTAR SEMUA USER</h2>
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Status</th>
                            <th>Money</th>
                            <th>Diamond</th>
                            <th>Rank</th>
                            <th>Stars</th>
                            <th>Terakhir Online</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab 2: Device Monitor -->
        <div id="devicesTab" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Mobile Devices</h3>
                    <div class="number" id="mobileCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>Desktop Devices</h3>
                    <div class="number" id="desktopCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>Android Users</h3>
                    <div class="number" id="androidCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>iOS Users</h3>
                    <div class="number" id="iosCount">0</div>
                </div>
            </div>
            
            <div class="users-table-container">
                <h2>üì± DEVICE MONITORING</h2>
                <table id="devicesTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Device</th>
                            <th>OS</th>
                            <th>Browser</th>
                            <th>Screen</th>
                            <th>Timezone</th>
                            <th>Last Update</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="devicesTableBody">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab 3: Online Users -->
        <div id="onlineTab" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>In Lobby</h3>
                    <div class="number" id="lobbyCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>In Game 1</h3>
                    <div class="number" id="game1Count">0</div>
                </div>
                <div class="stat-card">
                    <h3>In Game 2</h3>
                    <div class="number" id="game2Count">0</div>
                </div>
                <div class="stat-card">
                    <h3>Idle Users</h3>
                    <div class="number" id="idleCount">0</div>
                </div>
            </div>
            
            <div class="users-table-container">
                <h2>üü¢ USER ONLINE REAL-TIME</h2>
                <div id="onlineUsersList" class="device-grid">
                    <!-- Online users will be shown here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal untuk Device Detail -->
    <div id="deviceModal" class="device-modal">
        <div class="device-content">
            <div class="device-header">
                <h3 id="deviceModalTitle">üì± Device Information</h3>
                <button class="close-modal" onclick="closeDeviceModal()">√ó</button>
            </div>
            <div class="device-grid" id="deviceInfoGrid">
                <!-- Device info will be inserted here -->
            </div>
        </div>
    </div>
    
    <!-- Modal untuk Edit User -->
    <div id="editModal" class="action-modal">
        <div class="modal-content">
            <h3>‚úèÔ∏è Edit User</h3>
            <p id="editUserInfo"></p>
            <input type="number" id="editMoney" placeholder="Uang" min="0">
            <input type="number" id="editDiamond" placeholder="Diamond" min="0">
            <input type="number" id="editStars" placeholder="Stars" min="0">
            <input type="number" id="editRank" placeholder="Rank (0-12)" min="0" max="12">
            <div class="modal-buttons">
                <button class="save-btn" onclick="saveUserEdit()">SIMPAN</button>
                <button class="cancel-btn" onclick="closeModal()">BATAL</button>
            </div>
        </div>
    </div>
    
    <!-- Modal untuk Give Resources -->
    <div id="giveModal" class="action-modal">
        <div class="modal-content">
            <h3>üéÅ Give Resources</h3>
            <p id="giveUserInfo"></p>
            <input type="number" id="giveMoney" placeholder="Jumlah Uang" min="0">
            <input type="number" id="giveDiamond" placeholder="Jumlah Diamond" min="0">
            <div class="modal-buttons">
                <button class="save-btn" onclick="giveResources()">KASIHKAN</button>
                <button class="cancel-btn" onclick="closeModal()">BATAL</button>
            </div>
        </div>
    </div>
    
    <!-- Modal untuk Hapus Akun -->
    <div id="deleteModal" class="action-modal">
        <div class="modal-content">
            <h3>üóëÔ∏è Hapus Akun</h3>
            <p id="deleteUserInfo"></p>
            <p style="color:#ff6666;font-size:14px;margin:10px 0;">
                ‚ö†Ô∏è PERINGATAN: Tindakan ini tidak dapat dibatalkan!
                Semua data user akan dihapus permanen.
            </p>
            <input type="text" id="confirmUsername" placeholder="Ketik username untuk konfirmasi">
            <div class="modal-buttons">
                <button class="confirm-btn" onclick="confirmDelete()">HAPUS PERMANEN</button>
                <button class="cancel-btn" onclick="closeModal()">BATAL</button>
            </div>
        </div>
    </div>
    
    <script>
        // ==================== GLOBAL VARIABLES ====================
        let currentEditingUser = null;
        let allUsers = [];
        let allDevices = {};
        let realTimeListeners = [];
        
        // ==================== INITIALIZATION ====================
        window.onload = function() {
            const adminSession = localStorage.getItem('adminSession');
            if (adminSession === 'true') {
                showAdminPanel();
            } else {
                showLoginForm();
            }
        };
        
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
        }
        
        function showAdminPanel() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            
            // Update timestamp
            document.getElementById('lastUpdate').textContent = 
                'Last Update: ' + new Date().toLocaleTimeString('id-ID');
            
            // Load all data
            loadAllData();
            
            // Start real-time monitoring
            startRealTimeMonitoring();
        }
        
        function adminLogin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            if (username === 'Taher' && password === 'admin') {
                localStorage.setItem('adminSession', 'true');
                document.getElementById('adminName').textContent = username;
                showAdminPanel();
                showMessage('Login admin berhasil!', 'success');
            } else {
                showMessage('Username atau password salah!', 'error');
            }
        }
        
        function adminLogout() {
            // Stop all real-time listeners
            realTimeListeners.forEach(ref => ref.off());
            realTimeListeners = [];
            
            localStorage.removeItem('adminSession');
            showLoginForm();
        }
        
        function goBack() {
            window.location.href = 'lobby.html';
        }
        
        function refreshAllData() {
            loadAllData();
            showMessage('Data diperbarui!', 'success');
            document.getElementById('lastUpdate').textContent = 
                'Last Update: ' + new Date().toLocaleTimeString('id-ID');
        }
        
        // ==================== TAB MANAGEMENT ====================
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Activate corresponding tab button
            event.target.classList.add('active');
            
            // Load data for tab if needed
            if (tabName === 'devices') {
                loadDevicesTable();
            } else if (tabName === 'online') {
                loadOnlineUsers();
            }
        }
        
        // ==================== DATA LOADING ====================
        async function loadAllData() {
            try {
                // Load users
                const usersSnapshot = await database.ref('users').once('value');
                allUsers = [];
                usersSnapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    const uid = childSnapshot.key;
                    allUsers.push({ uid, ...user });
                });
                
                // Load device data
                const devicesSnapshot = await database.ref('user_stats').once('value');
                allDevices = devicesSnapshot.val() || {};
                
                // Update UI
                updateStatistics();
                loadUsersTable();
                loadDevicesTable();
                loadOnlineUsers();
                
            } catch (error) {
                showMessage('Error loading data: ' + error.message, 'error');
                console.error('Error loading all data:', error);
            }
        }
        
        function updateStatistics() {
            // User stats
            const totalUsers = allUsers.length;
            const onlineUsers = allUsers.filter(u => u.status === 'online').length;
            const bannedUsers = allUsers.filter(u => u.banned).length;
            
            // Device stats
            let mobileCount = 0, desktopCount = 0;
            let androidCount = 0, iosCount = 0;
            let playingCount = 0, lobbyCount = 0, game1Count = 0, game2Count = 0, idleCount = 0;
            
            for (const uid in allDevices) {
                const device = allDevices[uid];
                
                if (device.type === 'mobile') mobileCount++;
                if (device.type === 'desktop') desktopCount++;
                if (device.os === 'Android') androidCount++;
                if (device.os === 'iOS') iosCount++;
                
                // Check current page
                if (device.page) {
                    if (device.page.includes('game')) playingCount++;
                    if (device.page === 'lobby') lobbyCount++;
                    if (device.page.includes('GAME1')) game1Count++;
                    if (device.page.includes('GAME2')) game2Count++;
                    if (!device.page || device.page === 'unknown') idleCount++;
                }
            }
            
            // Update stats display
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('onlineUsers').textContent = onlineUsers;
            document.getElementById('bannedUsers').textContent = bannedUsers;
            document.getElementById('playingUsers').textContent = playingCount;
            
            document.getElementById('mobileCount').textContent = mobileCount;
            document.getElementById('desktopCount').textContent = desktopCount;
            document.getElementById('androidCount').textContent = androidCount;
            document.getElementById('iosCount').textContent = iosCount;
            
            document.getElementById('lobbyCount').textContent = lobbyCount;
            document.getElementById('game1Count').textContent = game1Count;
            document.getElementById('game2Count').textContent = game2Count;
            document.getElementById('idleCount').textContent = idleCount;
        }
        
        // ==================== USER MANAGEMENT ====================
        function loadUsersTable() {
            const usersTableBody = document.getElementById('usersTableBody');
            usersTableBody.innerHTML = '';
            
            allUsers.forEach(user => {
                // Status badge
                let statusBadge = '';
                if (user.banned) {
                    statusBadge = '<span class="status-badge banned-badge">BANNED</span>';
                } else if (user.status === 'online') {
                    statusBadge = '<span class="status-badge online-badge">ONLINE</span>';
                } else {
                    statusBadge = '<span class="status-badge offline-badge">OFFLINE</span>';
                }
                
                // Rank name
                const rankNames = ["Newbie","Junior","Senior","Great","Super Great","Legend",
                                  "Kings","Greatest","Mad Kings","Greatness","Unbeatable",
                                  "Monster Kings","Impossible"];
                const rankName = rankNames[user.rank || 0] || "Unknown";
                
                // Last online time
                const lastOnline = user.lastOnline ? 
                    formatTimeAgo(user.lastOnline) : 'Never';
                
                // Add to table
                usersTableBody.innerHTML += `
                    <tr>
                        <td>
                            <strong>${user.username}</strong><br>
                            <small style="color:#888;font-size:11px">${user.uid.substring(0, 8)}...</small>
                        </td>
                        <td>${statusBadge}</td>
                        <td>${user.money || 0}</td>
                        <td>${user.diamond || 0}</td>
                        <td>${rankName}</td>
                        <td>${user.stars || 0}</td>
                        <td>${lastOnline}</td>
                        <td style="white-space: nowrap;">
                            <button class="user-action-btn view-btn" onclick="viewDeviceInfo('${user.uid}')" title="View Device Info">View</button>
                            <button class="user-action-btn edit-btn" onclick="openEditModal('${user.uid}')" title="Edit User">Edit</button>
                            <button class="user-action-btn give-btn" onclick="openGiveModal('${user.uid}')" title="Give Resources">Give</button>
                            ${user.banned ? 
                                `<button class="user-action-btn unban-btn" onclick="toggleBan('${user.uid}', false)" title="Unban User">Unban</button>` :
                                `<button class="user-action-btn ban-btn" onclick="toggleBan('${user.uid}', true)" title="Ban User">Ban</button>`
                            }
                            <button class="user-action-btn kick-btn" onclick="forceLogout('${user.uid}')" title="Force Logout">Kick</button>
                            <button class="user-action-btn delete-btn" onclick="openDeleteModal('${user.uid}')" title="Delete User">Hapus</button>
                        </td>
                    </tr>
                `;
            });
        }
        
        function searchUser() {
            const searchTerm = document.getElementById('searchUser').value.toLowerCase();
            const usersTableBody = document.getElementById('usersTableBody');
            
            if (!searchTerm) {
                loadUsersTable();
                return;
            }
            
            const filteredUsers = allUsers.filter(user => 
                user.username.toLowerCase().includes(searchTerm) || 
                user.uid.toLowerCase().includes(searchTerm)
            );
            
            usersTableBody.innerHTML = '';
            
            filteredUsers.forEach(user => {
                let statusBadge = '';
                if (user.banned) {
                    statusBadge = '<span class="status-badge banned-badge">BANNED</span>';
                } else if (user.status === 'online') {
                    statusBadge = '<span class="status-badge online-badge">ONLINE</span>';
                } else {
                    statusBadge = '<span class="status-badge offline-badge">OFFLINE</span>';
                }
                
                usersTableBody.innerHTML += `
                    <tr>
                        <td><strong>${user.username}</strong></td>
                        <td>${statusBadge}</td>
                        <td>${user.money || 0}</td>
                        <td>${user.diamond || 0}</td>
                        <td>Rank ${user.rank || 0}</td>
                        <td>${user.stars || 0}</td>
                        <td>${user.lastOnline ? formatTimeAgo(user.lastOnline) : 'Never'}</td>
                        <td>
                            <button class="user-action-btn view-btn" onclick="viewDeviceInfo('${user.uid}')">View</button>
                            <button class="user-action-btn edit-btn" onclick="openEditModal('${user.uid}')">Edit</button>
                        </td>
                    </tr>
                `;
            });
        }
        
        function clearSearch() {
            document.getElementById('searchUser').value = '';
            loadUsersTable();
        }
        
        // ==================== DEVICE MONITORING ====================
        function loadDevicesTable() {
            const devicesTableBody = document.getElementById('devicesTableBody');
            devicesTableBody.innerHTML = '';
            
            let deviceCount = 0;
            
            for (const uid in allDevices) {
                const device = allDevices[uid];
                
                // Find user info
                const user = allUsers.find(u => u.uid === uid);
                if (!user) continue;
                
                deviceCount++;
                
                // Device icon
                const deviceIcon = device.type === 'mobile' ? 'üì±' : 
                                 device.type === 'tablet' ? 'üìü' : 'üíª';
                
                // Screen size
                const screenSize = device.w && device.h ? `${device.w}x${device.h}` : 'unknown';
                
                // Last update time
                const lastUpdate = device.t ? formatTimeAgo(device.t) : 'unknown';
                
                // Add to table
                devicesTableBody.innerHTML += `
                    <tr>
                        <td><strong>${user.username}</strong></td>
                        <td>${deviceIcon} ${device.type || 'unknown'}</td>
                        <td>${device.os || 'unknown'}</td>
                        <td>${device.browser || 'unknown'}</td>
                        <td>${screenSize}</td>
                        <td>${device.tz || 'unknown'}</td>
                        <td>${lastUpdate}</td>
                        <td>
                            <button class="user-action-btn view-btn" onclick="viewDeviceInfo('${uid}')">Details</button>
                        </td>
                    </tr>
                `;
            }
            
            if (deviceCount === 0) {
                devicesTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="loader">
                            Tidak ada device data yang ditemukan.
                        </td>
                    </tr>
                `;
            }
        }
        
        // ==================== ONLINE USERS ====================
        function loadOnlineUsers() {
            const onlineUsersList = document.getElementById('onlineUsersList');
            onlineUsersList.innerHTML = '';
            
            let onlineCount = 0;
            
            for (const uid in allDevices) {
                const device = allDevices[uid];
                const user = allUsers.find(u => u.uid === uid);
                
                if (!user || user.status !== 'online' || user.banned) continue;
                
                onlineCount++;
                
                // Get current activity
                let activity = 'Idle';
                let activityColor = '#888';
                
                if (device.page) {
                    if (device.page === 'lobby') {
                        activity = 'In Lobby';
                        activityColor = '#00ff88';
                    } else if (device.page.includes('game')) {
                        activity = 'Playing Game';
                        activityColor = '#ffd700';
                    }
                }
                
                // Calculate time since last update
                const lastSeen = device.t ? 
                    Math.floor((Date.now() - device.t) / 1000) : 999;
                const lastSeenText = lastSeen < 60 ? 
                    `${lastSeen}s ago` : `${Math.floor(lastSeen/60)}m ago`;
                
                onlineUsersList.innerHTML += `
                    <div class="info-card">
                        <h4>${user.username}</h4>
                        <div class="info-value" style="color:${activityColor}">${activity}</div>
                        <div class="info-detail">
                            üì± ${device.type || 'unknown'} | ${device.os || 'unknown'}<br>
                            üñ•Ô∏è ${device.w || 0}x${device.h || 0}<br>
                            üó∫Ô∏è ${device.tz || 'unknown'} | üïê ${lastSeenText}
                        </div>
                    </div>
                `;
            }
            
            if (onlineCount === 0) {
                onlineUsersList.innerHTML = `
                    <div class="info-card" style="grid-column:1/-1;text-align:center">
                        <h4>No Online Users</h4>
                        <div class="info-value">Tidak ada user yang online saat ini</div>
                    </div>
                `;
            }
        }
        
        // ==================== DEVICE DETAIL VIEW ====================
        function viewDeviceInfo(uid) {
            const device = allDevices[uid];
            const user = allUsers.find(u => u.uid === uid);
            
            if (!device || !user) {
                showMessage('Device info tidak ditemukan', 'error');
                return;
            }
            
            document.getElementById('deviceModalTitle').textContent = 
                `üì± ${user.username} - Device Details`;
            
            const deviceGrid = document.getElementById('deviceInfoGrid');
            deviceGrid.innerHTML = '';
            
            // Basic Info
            deviceGrid.innerHTML += `
                <div class="info-card">
                    <h4>üë§ User Info</h4>
                    <div class="info-value">${user.username}</div>
                    <div class="info-detail">UID: ${uid}</div>
                </div>
                
                <div class="info-card">
                    <h4>üì± Device Type</h4>
                    <div class="info-value">${device.type || 'unknown'}</div>
                    <div class="info-detail">${device.os || 'OS tidak terdeteksi'}</div>
                </div>
                
                <div class="info-card">
                    <h4>üåê Browser & Platform</h4>
                    <div class="info-value">${device.browser || 'unknown'}</div>
                    <div class="info-detail">Platform: ${device.plat || 'unknown'}</div>
                </div>
                
                <div class="info-card">
                    <h4>üñ•Ô∏è Screen & Language</h4>
                    <div class="info-value">${device.w || 0}x${device.h || 0}</div>
                    <div class="info-detail">Language: ${device.lang || 'unknown'}</div>
                </div>
            `;
            
            // Connection Info
            deviceGrid.innerHTML += `
                <div class="info-card">
                    <h4>üì∂ Connection</h4>
                    <div class="info-value">${device.conn || 'unknown'}</div>
                    <div class="info-detail">
                        ${device.down ? `Speed: ${device.down} Mbps<br>` : ''}
                        Online: ${device.online ? 'Yes' : 'No'}
                    </div>
                </div>
            `;
            
            // Location & Time
            deviceGrid.innerHTML += `
                <div class="info-card">
                    <h4>üó∫Ô∏è Location & Time</h4>
                    <div class="info-value">${device.tz || 'unknown'}</div>
                    <div class="info-detail">
                        Last Update: ${device.t ? formatTimeAgo(device.t) : 'Never'}<br>
                        Current Page: ${device.page || 'unknown'}
                    </div>
                </div>
            `;
            
            document.getElementById('deviceModal').classList.add('active');
        }
        
        function closeDeviceModal() {
            document.getElementById('deviceModal').classList.remove('active');
        }
        
        // ==================== REAL-TIME MONITORING ====================
        function startRealTimeMonitoring() {
            // Listen for user updates
            const usersRef = database.ref('users');
            realTimeListeners.push(usersRef);
            
            usersRef.on('value', (snapshot) => {
                allUsers = [];
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    const uid = childSnapshot.key;
                    allUsers.push({ uid, ...user });
                });
                
                updateStatistics();
                
                // Refresh current tab if on users tab
                if (document.getElementById('usersTab').classList.contains('active')) {
                    loadUsersTable();
                }
                if (document.getElementById('onlineTab').classList.contains('active')) {
                    loadOnlineUsers();
                }
            });
            
            // Listen for device updates
            const devicesRef = database.ref('user_stats');
            realTimeListeners.push(devicesRef);
            
            devicesRef.on('value', (snapshot) => {
                allDevices = snapshot.val() || {};
                
                updateStatistics();
                
                // Refresh current tab based on active tab
                const activeTab = document.querySelector('.tab-content.active').id;
                if (activeTab === 'devicesTab') loadDevicesTable();
                if (activeTab === 'onlineTab') loadOnlineUsers();
            });
        }
        
        // ==================== HELPER FUNCTIONS ====================
        function formatTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            
            if (seconds < 60) return `${seconds} detik lalu`;
            if (seconds < 3600) return `${Math.floor(seconds/60)} menit lalu`;
            if (seconds < 86400) return `${Math.floor(seconds/3600)} jam lalu`;
            return `${Math.floor(seconds/86400)} hari lalu`;
        }
        
        function showMessage(text, type) {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 3000);
        }
        
        // ==================== EDIT USER ====================
        function openEditModal(uid) {
            const user = allUsers.find(u => u.uid === uid);
            if (!user) {
                showMessage('User tidak ditemukan', 'error');
                return;
            }
            
            currentEditingUser = uid;
            
            document.getElementById('editUserInfo').textContent = 
                `Edit data untuk: ${user.username}`;
            
            document.getElementById('editMoney').value = user.money || 0;
            document.getElementById('editDiamond').value = user.diamond || 0;
            document.getElementById('editStars').value = user.stars || 0;
            document.getElementById('editRank').value = user.rank || 0;
            
            document.getElementById('editModal').classList.add('active');
            document.getElementById('editMoney').focus();
        }
        
        async function saveUserEdit() {
            if (!currentEditingUser) {
                showMessage('Tidak ada user yang dipilih', 'error');
                return;
            }
            
            const money = parseInt(document.getElementById('editMoney').value) || 0;
            const diamond = parseInt(document.getElementById('editDiamond').value) || 0;
            const stars = parseInt(document.getElementById('editStars').value) || 0;
            const rank = parseInt(document.getElementById('editRank').value) || 0;
            
            if (money < 0 || diamond < 0 || stars < 0) {
                showMessage('Nilai tidak boleh minus', 'error');
                return;
            }
            
            if (rank < 0 || rank > 12) {
                showMessage('Rank harus antara 0-12', 'error');
                return;
            }
            
            try {
                await database.ref('users/' + currentEditingUser).update({
                    money: money,
                    diamond: diamond,
                    stars: stars,
                    rank: rank,
                    lastEdited: Date.now(),
                    editedBy: 'admin'
                });
                
                // Update local data
                const userIndex = allUsers.findIndex(u => u.uid === currentEditingUser);
                if (userIndex !== -1) {
                    allUsers[userIndex].money = money;
                    allUsers[userIndex].diamond = diamond;
                    allUsers[userIndex].stars = stars;
                    allUsers[userIndex].rank = rank;
                }
                
                showMessage('‚úÖ User berhasil diupdate!', 'success');
                closeModal();
                loadUsersTable();
                
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
            }
        }
        
        // ==================== GIVE RESOURCES ====================
        function openGiveModal(uid) {
            const user = allUsers.find(u => u.uid === uid);
            if (!user) {
                showMessage('User tidak ditemukan', 'error');
                return;
            }
            
            currentEditingUser = uid;
            
            document.getElementById('giveUserInfo').textContent = 
                `Give resources ke: ${user.username}`;
            
            document.getElementById('giveMoney').value = '';
            document.getElementById('giveDiamond').value = '';
            
            document.getElementById('giveModal').classList.add('active');
            document.getElementById('giveMoney').focus();
        }
        
        async function giveResources() {
            if (!currentEditingUser) {
                showMessage('Tidak ada user yang dipilih', 'error');
                return;
            }
            
            const addMoney = parseInt(document.getElementById('giveMoney').value) || 0;
            const addDiamond = parseInt(document.getElementById('giveDiamond').value) || 0;
            
            if (addMoney <= 0 && addDiamond <= 0) {
                showMessage('Masukkan jumlah yang valid', 'error');
                return;
            }
            
            if (addMoney < 0 || addDiamond < 0) {
                showMessage('Jumlah tidak boleh minus', 'error');
                return;
            }
            
            try {
                const snapshot = await database.ref('users/' + currentEditingUser).once('value');
                const user = snapshot.val();
                
                if (!user) {
                    showMessage('User tidak ditemukan di database', 'error');
                    return;
                }
                
                const currentMoney = parseInt(user.money) || 0;
                const currentDiamond = parseInt(user.diamond) || 0;
                
                const newMoney = currentMoney + addMoney;
                const newDiamond = currentDiamond + addDiamond;
                
                await database.ref('users/' + currentEditingUser).update({
                    money: newMoney,
                    diamond: newDiamond,
                    lastGift: Date.now(),
                    giftedBy: 'admin'
                });
                
                const userIndex = allUsers.findIndex(u => u.uid === currentEditingUser);
                if (userIndex !== -1) {
                    allUsers[userIndex].money = newMoney;
                    allUsers[userIndex].diamond = newDiamond;
                }
                
                let message = '‚úÖ Berhasil memberi ';
                if (addMoney > 0) message += `${addMoney} Money `;
                if (addDiamond > 0) message += `${addDiamond} Diamond`;
                message += ` ke user!`;
                
                showMessage(message, 'success');
                closeModal();
                loadUsersTable();
                
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
            }
        }
        
        // ==================== BAN/UNBAN USER ====================
        async function toggleBan(uid, ban) {
            const user = allUsers.find(u => u.uid === uid);
            if (!user) {
                showMessage('User tidak ditemukan', 'error');
                return;
            }
            
            const action = ban ? 'BAN' : 'UNBAN';
            const username = user.username;
            
            const reason = prompt(
                `${action} user: ${username}\n\n` +
                `Masukkan alasan ${action.toLowerCase()} (optional):`
            );
            
            if (ban && !confirm(
                `Yakin ingin BAN user ${username}?\n\n` +
                `Alasan: ${reason || 'No reason provided'}\n\n` +
                `User tidak akan bisa login lagi!`
            )) {
                return;
            }
            
            try {
                const updates = {
                    banned: ban,
                    status: ban ? 'banned' : 'offline',
                    lastOnline: firebase.database.ServerValue.TIMESTAMP
                };
                
                if (ban) {
                    updates.banHistory = {
                        action: 'BAN',
                        timestamp: Date.now(),
                        by: 'admin',
                        reason: reason || 'Admin action',
                        admin: 'Taher'
                    };
                    updates.banDate = new Date().toISOString();
                }
                
                await database.ref('users/' + uid).update(updates);
                
                if (ban) {
                    await database.ref('user_stats/' + uid).update({
                        online: false,
                        banned: true,
                        forceLogout: true
                    });
                }
                
                showMessage(`‚úÖ User ${username} berhasil di${ban ? 'BAN' : 'UNBAN'}!`, 'success');
                
                // Update local data
                const userIndex = allUsers.findIndex(u => u.uid === uid);
                if (userIndex !== -1) {
                    allUsers[userIndex].banned = ban;
                    allUsers[userIndex].status = ban ? 'banned' : 'offline';
                }
                
                loadUsersTable();
                updateStatistics();
                
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
            }
        }
        
        // ==================== FORCE LOGOUT ====================
        async function forceLogout(uid) {
            const user = allUsers.find(u => u.uid === uid);
            if (!user) {
                showMessage('User tidak ditemukan', 'error');
                return;
            }
            
            if (!confirm(`Force logout user ${user.username}?\nUser akan dikick dari semua sesi.`)) {
                return;
            }
            
            try {
                await database.ref('users/' + uid).update({
                    status: 'offline',
                    lastOnline: firebase.database.ServerValue.TIMESTAMP,
                    forceLogout: Date.now(),
                    forceBy: 'admin'
                });
                
                await database.ref('user_stats/' + uid).update({
                    online: false,
                    forceLogout: true
                });
                
                const userIndex = allUsers.findIndex(u => u.uid === uid);
                if (userIndex !== -1) {
                    allUsers[userIndex].status = 'offline';
                }
                
                showMessage(`‚úÖ User ${user.username} berhasil di force logout!`, 'success');
                loadUsersTable();
                
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
            }
        }
        
        // ==================== DELETE USER ====================
        function openDeleteModal(uid) {
            const user = allUsers.find(u => u.uid === uid);
            if (!user) {
                showMessage('User tidak ditemukan', 'error');
                return;
            }
            
            currentEditingUser = uid;
            
            document.getElementById('deleteUserInfo').textContent = 
                `Hapus akun PERMANEN: ${user.username}`;
            
            document.getElementById('confirmUsername').value = '';
            
            document.getElementById('deleteModal').classList.add('active');
            document.getElementById('confirmUsername').focus();
        }
        
        async function confirmDelete() {
            if (!currentEditingUser) {
                showMessage('Tidak ada user yang dipilih', 'error');
                return;
            }
            
            const user = allUsers.find(u => u.uid === currentEditingUser);
            if (!user) {
                showMessage('User tidak ditemukan', 'error');
                return;
            }
            
            const confirmInput = document.getElementById('confirmUsername').value.trim();
            const username = user.username;
            
            if (confirmInput !== username) {
                showMessage('Username tidak cocok!', 'error');
                return;
            }
            
            const finalWarning = `‚ö†Ô∏è PERINGATAN AKHIR! ‚ö†Ô∏è\n\n` +
                `YAKIN ingin menghapus PERMANEN akun:\n` +
                `üë§ ${username}\n\n` +
                `üö® TINDAKAN INI TIDAK BISA DIBATALKAN!\n` +
                `üö® Semua data user akan dihapus selamanya!\n\n` +
                `Ketik: "YA, HAPUS PERMANEN" untuk konfirmasi`;
            
            const finalConfirm = prompt(finalWarning);
            if (finalConfirm !== "YA, HAPUS PERMANEN") {
                showMessage('Penghapusan dibatalkan', 'warning');
                closeModal();
                return;
            }
            
            try {
                await database.ref('users/' + currentEditingUser).remove();
                await database.ref('user_stats/' + currentEditingUser).remove();
                
                const friendsSnapshot = await database.ref('friends').once('value');
                const deletePromises = [];
                
                friendsSnapshot.forEach((childSnapshot) => {
                    const friendUid = childSnapshot.key;
                    deletePromises.push(
                        database.ref('friends/' + friendUid + '/' + currentEditingUser).remove()
                    );
                });
                
                await Promise.all(deletePromises);
                await database.ref('friends/' + currentEditingUser).remove();
                
                allUsers = allUsers.filter(u => u.uid !== currentEditingUser);
                delete allDevices[currentEditingUser];
                
                showMessage(`‚úÖ Akun ${username} berhasil dihapus PERMANEN!`, 'success');
                closeModal();
                
                updateStatistics();
                loadUsersTable();
                loadDevicesTable();
                loadOnlineUsers();
                
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
            }
        }
        
        // ==================== CLOSE MODAL ====================
        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('giveModal').classList.remove('active');
            document.getElementById('deleteModal').classList.remove('active');
            currentEditingUser = null;
        }
        
        // Close modal dengan Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeDeviceModal();
                closeModal();
            }
        });
    </script>
</body>
</html>
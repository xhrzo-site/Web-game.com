<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAP BATTLE - VS Teman Online!</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <style>
        /* ==================== BASE STYLES ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }

        :root {
            --player1: #ff4757;
            --player2: #3742fa;
            --player3: #2ed573;
            --player4: #ffa502;
            --dark: #1e272e;
            --light: #f1f2f6;
            --danger: #ff3838;
            --success: #32ff7e;
            --warning: #ff9f1a;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, #0c2461, #1e3799);
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            color: white;
        }

        /* ==================== LOBBY SCREEN ==================== */
        .lobby-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            gap: 20px;
        }

        .lobby-title {
            font-size: 3em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px #ffd700;
            margin-bottom: 10px;
        }

        .lobby-subtitle {
            font-size: 1.2em;
            color: rgba(255,255,255,0.8);
            text-align: center;
            max-width: 90%;
        }

        .room-code-box {
            background: rgba(255,255,255,0.1);
            border: 3px solid #ffd700;
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            margin: 20px 0;
        }

        .room-code {
            font-size: 3em;
            font-weight: bold;
            letter-spacing: 10px;
            color: #ffd700;
            margin: 15px 0;
            font-family: monospace;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 10px;
        }

        .player-list {
            width: 90%;
            max-width: 400px;
            background: rgba(0,0,0,0.5);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border-left: 5px solid var(--player1);
        }

        .player-item.ready {
            border-left-color: var(--success);
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--player1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 15px;
        }

        .player-name {
            flex: 1;
            font-size: 18px;
            font-weight: bold;
        }

        .player-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-waiting {
            background: rgba(255, 165, 2, 0.3);
            color: #ffa502;
        }

        .status-ready {
            background: rgba(50, 255, 126, 0.3);
            color: #32ff7e;
        }

        .lobby-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .lobby-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lobby-btn:active {
            transform: scale(0.95);
        }

        .btn-ready {
            background: linear-gradient(135deg, #32ff7e, #2ed573);
            color: #1e272e;
        }

        .btn-invite {
            background: linear-gradient(135deg, #3742fa, #5352ed);
            color: white;
        }

        .btn-leave {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            color: white;
        }

        .invite-box {
            background: rgba(0,0,0,0.7);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .invite-box.active {
            display: block;
        }

        .invite-title {
            font-size: 16px;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .invite-link {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
            word-break: break-all;
            font-size: 14px;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .share-btn {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }

        /* ==================== GAME SCREEN ==================== */
        .game-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }

        /* Game Header */
        .game-header {
            height: 80px;
            background: rgba(30, 39, 46, 0.95);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            border-bottom: 3px solid #ffd700;
        }

        .timer-box {
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 15px;
            border: 2px solid #ffd700;
        }

        .timer {
            font-size: 28px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
        }

        .round-info {
            text-align: center;
        }

        .round-text {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }

        .round-number {
            font-size: 20px;
            font-weight: bold;
            color: white;
        }

        /* Game Arena */
        .game-arena {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        .player-side {
            flex: 1;
            position: relative;
            border-right: 2px solid rgba(255,255,255,0.1);
        }

        .player-side:last-child {
            border-right: none;
        }

        .player-header {
            height: 50px;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            padding: 0 15px;
            border-bottom: 2px solid;
        }

        .player1 .player-header { border-color: var(--player1); }
        .player2 .player-header { border-color: var(--player2); }
        .player3 .player-header { border-color: var(--player3); }
        .player4 .player-header { border-color: var(--player4); }

        .player-score {
            margin-left: auto;
            font-size: 24px;
            font-weight: bold;
        }

        .player1 .player-score { color: var(--player1); }
        .player2 .player-score { color: var(--player2); }
        .player3 .player-score { color: var(--player3); }
        .player4 .player-score { color: var(--player4); }

        .tap-zone {
            position: absolute;
            top: 50px;
            bottom: 0;
            left: 0;
            right: 0;
            cursor: pointer;
        }

        .tap-target {
            position: absolute;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            font-weight: bold;
            animation: float 3s infinite ease-in-out;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.1s;
            cursor: pointer;
        }

        .tap-target:active {
            transform: scale(0.9);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }

        .tap-effect {
            position: absolute;
            font-size: 40px;
            font-weight: bold;
            pointer-events: none;
            z-index: 100;
            animation: pop 0.6s forwards;
        }

        @keyframes pop {
            0% { transform: scale(0.5); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }

        .combo-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
        }

        /* Powerups Bar */
        .powerups-bar {
            height: 70px;
            background: rgba(30, 39, 46, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            border-top: 3px solid #ffd700;
        }

        .powerup-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .powerup-btn:active {
            transform: scale(0.9);
        }

        .powerup-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .powerup-btn.bomb { border-color: var(--danger); }
        .powerup-btn.freeze { border-color: #18dcff; }
        .powerup-btn.confuse { border-color: #8e44ad; }
        .powerup-btn.multiply { border-color: var(--success); }

        /* ==================== RESULTS SCREEN ==================== */
        .results-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .results-content {
            background: linear-gradient(135deg, #1e272e, #2d3436);
            width: 90%;
            max-width: 500px;
            border-radius: 25px;
            padding: 30px;
            border: 5px solid #ffd700;
            text-align: center;
            box-shadow: 0 30px 60px rgba(255, 215, 0, 0.3);
        }

        .results-title {
            font-size: 2.5em;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #ffd700;
        }

        .winner-badge {
            background: linear-gradient(135deg, #ffd700, #ffa502);
            color: #1e272e;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 24px;
            font-weight: bold;
            margin: 20px auto;
            display: inline-block;
        }

        .leaderboard {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .leaderboard-rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ffd700;
            color: #1e272e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .leaderboard-name {
            flex: 1;
            text-align: left;
            font-size: 18px;
            font-weight: bold;
        }

        .leaderboard-score {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
        }

        .results-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .results-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .results-btn:active {
            transform: scale(0.95);
        }

        .btn-rematch {
            background: linear-gradient(135deg, #32ff7e, #2ed573);
            color: #1e272e;
        }

        .btn-new-game {
            background: linear-gradient(135deg, #3742fa, #5352ed);
            color: white;
        }

        .btn-lobby {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            color: white;
        }

        /* ==================== NOTIFICATIONS ==================== */
        .notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 10px;
            border: 2px solid #ffd700;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100px); }
            to { transform: translateX(-50%) translateY(0); }
        }

        .notification-icon {
            font-size: 20px;
        }

        /* ==================== CHAT SYSTEM ==================== */
        .chat-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 400px;
            background: rgba(30, 39, 46, 0.95);
            border-radius: 15px;
            border: 2px solid #ffd700;
            display: none;
            flex-direction: column;
            z-index: 1000;
        }

        .chat-header {
            padding: 15px;
            background: rgba(0,0,0,0.5);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 15px 15px 0 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            max-width: 80%;
        }

        .chat-message.own {
            background: rgba(255, 215, 0, 0.2);
            margin-left: auto;
        }

        .message-sender {
            font-size: 12px;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .message-text {
            font-size: 14px;
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .chat-input button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #ffd700;
            color: #1e272e;
            font-weight: bold;
            cursor: pointer;
        }

        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #ffd700;
            color: #1e272e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.5);
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .lobby-title {
                font-size: 2em;
            }
            
            .room-code {
                font-size: 2em;
                letter-spacing: 5px;
            }
            
            .lobby-buttons {
                flex-direction: column;
                width: 90%;
            }
            
            .game-header {
                height: 60px;
                padding: 0 10px;
            }
            
            .timer {
                font-size: 20px;
            }
            
            .player-header {
                height: 40px;
                padding: 0 10px;
            }
            
            .player-score {
                font-size: 18px;
            }
            
            .powerups-bar {
                height: 60px;
                gap: 10px;
            }
            
            .powerup-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .chat-box {
                width: 90%;
                height: 300px;
                right: 5%;
            }
        }

        /* ==================== ANIMATIONS ==================== */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.5s;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .flash {
            animation: flash 0.5s infinite;
        }

        /* ==================== LOADING ==================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
            gap: 20px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.1);
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s infinite linear;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #ffd700;
            font-size: 18px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Lobby Screen -->
    <div class="lobby-screen" id="lobbyScreen">
        <div class="lobby-title">üéÆ TAP BATTLE üéÆ</div>
        <div class="lobby-subtitle">Battle tap-tapan real-time vs teman!</div>
        
        <div class="room-code-box" id="roomCodeBox">
            <div>ROOM CODE</div>
            <div class="room-code" id="roomCode">----</div>
            <div style="font-size: 14px; color: rgba(255,255,255,0.7);">
                Share code ini ke temanmu!
            </div>
        </div>
        
        <div class="player-list" id="playerList">
            <div class="player-item">
                <div class="player-avatar">üë§</div>
                <div class="player-name" id="playerName">You</div>
                <div class="player-status status-waiting">WAITING</div>
            </div>
        </div>
        
        <div class="lobby-buttons">
            <button class="lobby-btn btn-ready" onclick="toggleReady()" id="readyBtn">
                <span>‚úÖ</span>
                READY
            </button>
            <button class="lobby-btn btn-invite" onclick="toggleInviteBox()">
                <span>üì§</span>
                INVITE
            </button>
            <button class="lobby-btn btn-leave" onclick="leaveRoom()">
                <span>üö™</span>
                LEAVE
            </button>
        </div>
        
        <div class="invite-box" id="inviteBox">
            <div class="invite-title">Undang Teman</div>
            <div class="invite-link" id="inviteLink">Loading...</div>
            <div class="share-buttons">
                <button class="share-btn" onclick="shareRoom('whatsapp')">
                    <span>üì±</span> WhatsApp
                </button>
                <button class="share-btn" onclick="shareRoom('copy')">
                    <span>üìã</span> Copy Link
                </button>
                <button class="share-btn" onclick="shareRoom('qr')">
                    <span>üî≤</span> QR Code
                </button>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div class="game-screen" id="gameScreen">
        <!-- Game Header -->
        <div class="game-header">
            <div class="timer-box">
                <div class="timer" id="gameTimer">60</div>
            </div>
            <div class="round-info">
                <div class="round-text">ROUND</div>
                <div class="round-number" id="roundNumber">1/3</div>
            </div>
            <button class="lobby-btn btn-leave" onclick="leaveGame()" style="padding: 10px 20px; font-size: 14px;">
                <span>üèÉ</span> LEAVE
            </button>
        </div>
        
        <!-- Game Arena -->
        <div class="game-arena" id="gameArena">
            <!-- Player sides will be generated dynamically -->
        </div>
        
        <!-- Powerups Bar -->
        <div class="powerups-bar">
            <button class="powerup-btn bomb" onclick="usePowerup('bomb')" title="Kirim bomb ke lawan">
                üí£
            </button>
            <button class="powerup-btn freeze" onclick="usePowerup('freeze')" title="Bekukan lawan 3 detik">
                ‚ùÑÔ∏è
            </button>
            <button class="powerup-btn confuse" onclick="usePowerup('confuse')" title="Bikin lawan pusing">
                üåÄ
            </button>
            <button class="powerup-btn multiply" onclick="usePowerup('multiply')" title="Double score 5 detik">
                ‚úñÔ∏è
            </button>
        </div>
    </div>

    <!-- Results Screen -->
    <div class="results-screen" id="resultsScreen">
        <div class="results-content">
            <div class="results-title">BATTLE RESULTS</div>
            <div class="winner-badge" id="winnerBadge">üèÜ YOU WIN! üèÜ</div>
            <div class="leaderboard" id="leaderboard">
                <!-- Leaderboard will be generated here -->
            </div>
            <div class="results-buttons">
                <button class="results-btn btn-rematch" onclick="requestRematch()">
                    üîÑ REMATCH
                </button>
                <button class="results-btn btn-new-game" onclick="newGame()">
                    üéÆ NEW GAME
                </button>
                <button class="results-btn btn-lobby" onclick="backToLobby()">
                    üè† LOBBY
                </button>
            </div>
        </div>
    </div>

    <!-- Chat System -->
    <div class="chat-toggle" onclick="toggleChat()">
        üí¨
    </div>
    <div class="chat-box" id="chatBox">
        <div class="chat-header">
            <div>üí¨ Battle Chat</div>
            <button onclick="toggleChat()" style="background: none; border: none; color: white; font-size: 20px;">√ó</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Ketik pesan..." maxlength="100">
            <button onclick="sendChatMessage()">‚û§</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Connecting...</div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-icon" id="notificationIcon">üí¨</div>
        <div class="notification-text" id="notificationText">Hello!</div>
    </div>

    <script>
        // ==================== GAME CONFIGURATION ====================
        const CONFIG = {
            ROOM: {
                MAX_PLAYERS: 4,
                GAME_DURATION: 60, // seconds
                ROUNDS: 3,
                READY_COUNTDOWN: 5 // seconds
            },
            GAMEPLAY: {
                TARGET_SPAWN_RATE: 800, // ms
                TARGET_LIFETIME: 3000,  // ms
                BASE_SCORE: 10,
                COMBO_MULTIPLIER: 0.1,
                MAX_COMBO: 5,
                POWERUP_COST: 50,
                POWERUP_COOLDOWN: 10000 // ms
            },
            TARGETS: {
                TYPES: ['normal', 'bonus', 'bomb', 'mystery'],
                SIZES: [50, 60, 70, 80],
                VALUES: {
                    normal: 10,
                    bonus: 50,
                    bomb: -30,
                    mystery: { min: -20, max: 100 }
                },
                EMOJIS: {
                    normal: ['üéØ', 'üéÆ', 'üé≤', 'üé™', 'üé®'],
                    bonus: ['üíé', 'üí∞', 'üíµ', 'üëë', 'üèÜ'],
                    bomb: ['üí£', 'üß®', '‚ò†Ô∏è', '‚ö†Ô∏è', 'üö®'],
                    mystery: ['‚ùì', 'üéÅ', 'üé∞', 'üîÆ', '‚ú®']
                }
            },
            POWERUPS: {
                BOMB: {
                    name: "Bomb Attack",
                    effect: "Kirim bomb ke semua lawan",
                    duration: 2000,
                    cooldown: 15000
                },
                FREEZE: {
                    name: "Freeze Ray",
                    effect: "Bekukan lawan selama 3 detik",
                    duration: 3000,
                    cooldown: 20000
                },
                CONFUSE: {
                    name: "Confusion",
                    effect: "Bikin target lawan bergerak acak",
                    duration: 5000,
                    cooldown: 12000
                },
                MULTIPLY: {
                    name: "Score Multiplier",
                    effect: "Double score selama 5 detik",
                    duration: 5000,
                    cooldown: 25000
                }
            }
        };

        // ==================== GLOBAL VARIABLES ====================
        let gameState = {
            playerId: null,
            playerName: "Player",
            roomId: null,
            roomCode: null,
            isHost: false,
            isReady: false,
            players: {},
            gameActive: false,
            round: 1,
            timeLeft: CONFIG.ROOM.GAME_DURATION,
            scores: {},
            combos: {},
            powerups: {},
            gameTimer: null,
            targetTimers: {},
            chatMessages: []
        };

        // Firebase references
        let roomRef = null;
        let gameRef = null;
        let chatRef = null;

        // DOM Elements
        const elements = {
            lobbyScreen: document.getElementById('lobbyScreen'),
            gameScreen: document.getElementById('gameScreen'),
            resultsScreen: document.getElementById('resultsScreen'),
            roomCode: document.getElementById('roomCode'),
            playerList: document.getElementById('playerList'),
            playerName: document.getElementById('playerName'),
            readyBtn: document.getElementById('readyBtn'),
            inviteBox: document.getElementById('inviteBox'),
            inviteLink: document.getElementById('inviteLink'),
            gameArena: document.getElementById('gameArena'),
            gameTimer: document.getElementById('gameTimer'),
            roundNumber: document.getElementById('roundNumber'),
            notification: document.getElementById('notification'),
            notificationIcon: document.getElementById('notificationIcon'),
            notificationText: document.getElementById('notificationText'),
            chatBox: document.getElementById('chatBox'),
            chatMessages: document.getElementById('chatMessages'),
            chatInput: document.getElementById('chatInput'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingText: document.getElementById('loadingText')
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading("Loading game...");
            
            // Generate player ID
            gameState.playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Get player name from localStorage or generate
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    gameState.playerName = user.username || "Player";
                } catch (e) {
                    gameState.playerName = "Player";
                }
            }
            
            // Update UI
            elements.playerName.textContent = gameState.playerName;
            
            // Check for room code in URL
            const urlParams = new URLSearchParams(window.location.search);
            const roomCode = urlParams.get('room');
            
            if (roomCode) {
                // Join existing room
                await joinRoom(roomCode.toUpperCase());
            } else {
                // Create new room
                await createRoom();
            }
            
            hideLoading();
        });

        // ==================== ROOM MANAGEMENT ====================
        async function createRoom() {
            showLoading("Creating room...");
            
            // Generate room code (4 letters)
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            gameState.roomCode = code;
            gameState.roomId = 'room_' + code;
            gameState.isHost = true;
            
            // Create room in Firebase
            roomRef = database.ref('battle_rooms/' + gameState.roomId);
            
            // Set initial room data
            await roomRef.set({
                code: code,
                host: gameState.playerId,
                status: 'waiting',
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                players: {
                    [gameState.playerId]: {
                        id: gameState.playerId,
                        name: gameState.playerName,
                        ready: false,
                        joinedAt: Date.now()
                    }
                }
            });
            
            // Listen for room changes
            setupRoomListeners();
            
            // Update UI
            elements.roomCode.textContent = code;
            updatePlayerList();
            
            // Update invite link
            updateInviteLink();
            
            showNotification("Room created!", `Code: ${code}`, "üéÆ");
            hideLoading();
        }

        async function joinRoom(code) {
            showLoading(`Joining room ${code}...`);
            
            gameState.roomCode = code.toUpperCase();
            gameState.roomId = 'room_' + code.toUpperCase();
            
            // Check if room exists
            const snapshot = await database.ref('battle_rooms/' + gameState.roomId).once('value');
            
            if (!snapshot.exists()) {
                showNotification("Room not found", "Check the code and try again", "‚ùå");
                hideLoading();
                setTimeout(() => window.location.href = 'lobby.html', 2000);
                return;
            }
            
            const roomData = snapshot.val();
            
            // Check if room is full
            const playerCount = roomData.players ? Object.keys(roomData.players).length : 0;
            if (playerCount >= CONFIG.ROOM.MAX_PLAYERS) {
                showNotification("Room is full", "Maximum 4 players", "üö´");
                hideLoading();
                setTimeout(() => window.location.href = 'lobby.html', 2000);
                return;
            }
            
            // Check if game already started
            if (roomData.status === 'playing') {
                showNotification("Game already started", "Please wait for next round", "‚è≥");
                hideLoading();
                setTimeout(() => window.location.href = 'lobby.html', 2000);
                return;
            }
            
            // Join room
            roomRef = database.ref('battle_rooms/' + gameState.roomId);
            
            await roomRef.child('players/' + gameState.playerId).set({
                id: gameState.playerId,
                name: gameState.playerName,
                ready: false,
                joinedAt: Date.now()
            });
            
            // Setup listeners
            setupRoomListeners();
            
            // Update UI
            elements.roomCode.textContent = code.toUpperCase();
            updateInviteLink();
            
            showNotification("Joined room!", `Welcome to ${code}`, "üëã");
            hideLoading();
        }

        function setupRoomListeners() {
            // Listen for room updates
            roomRef.on('value', (snapshot) => {
                const roomData = snapshot.val();
                if (!roomData) return;
                
                // Update players
                gameState.players = roomData.players || {};
                
                // Update room status
                if (roomData.status === 'starting' && !gameState.gameActive) {
                    startGameCountdown();
                }
                
                if (roomData.status === 'playing' && !gameState.gameActive) {
                    startGame();
                }
                
                if (roomData.status === 'finished') {
                    showResults(roomData.results);
                }
                
                // Update UI
                updatePlayerList();
            });
            
            // Listen for game actions
            gameRef = database.ref('battle_games/' + gameState.roomId);
            
            // Listen for powerups
            gameRef.child('powerups').on('child_added', (snapshot) => {
                const powerup = snapshot.val();
                if (powerup.target === gameState.playerId) {
                    applyPowerup(powerup.type, powerup.sender);
                }
            });
            
            // Listen for chat messages
            chatRef = database.ref('battle_chat/' + gameState.roomId);
            
            chatRef.limitToLast(20).on('child_added', (snapshot) => {
                const message = snapshot.val();
                addChatMessage(message);
            });
        }

        // ==================== PLAYER MANAGEMENT ====================
        function updatePlayerList() {
            elements.playerList.innerHTML = '';
            
            Object.values(gameState.players).forEach(player => {
                const isMe = player.id === gameState.playerId;
                
                const playerItem = document.createElement('div');
                playerItem.className = `player-item ${player.ready ? 'ready' : ''}`;
                
                // Player color based on position
                const playerIndex = Object.keys(gameState.players).indexOf(player.id);
                const colors = ['#ff4757', '#3742fa', '#2ed573', '#ffa502'];
                const playerColor = colors[playerIndex] || '#666';
                
                playerItem.style.borderLeftColor = playerColor;
                
                playerItem.innerHTML = `
                    <div class="player-avatar" style="background: ${playerColor}">
                        ${playerIndex + 1}
                    </div>
                    <div class="player-name">
                        ${player.name} ${isMe ? '(You)' : ''}
                    </div>
                    <div class="player-status ${player.ready ? 'status-ready' : 'status-waiting'}">
                        ${player.ready ? 'READY' : 'WAITING'}
                    </div>
                `;
                
                elements.playerList.appendChild(playerItem);
            });
        }

        async function toggleReady() {
            const newReadyState = !gameState.isReady;
            
            await roomRef.child('players/' + gameState.playerId + '/ready').set(newReadyState);
            gameState.isReady = newReadyState;
            
            elements.readyBtn.innerHTML = newReadyState ? 
                '<span>‚ùå</span> NOT READY' : 
                '<span>‚úÖ</span> READY';
            
            // Check if all players are ready
            checkAllReady();
        }

        function checkAllReady() {
            const players = Object.values(gameState.players);
            const allReady = players.length > 1 && players.every(p => p.ready);
            
            if (allReady && gameState.isHost) {
                // Start countdown
                roomRef.update({ status: 'starting' });
                
                // Countdown before game starts
                let countdown = CONFIG.ROOM.READY_COUNTDOWN;
                showNotification(`Game starting in ${countdown}...`, "Get ready!", "üéÆ");
                
                const countdownInterval = setInterval(() => {
                    countdown--;
                    
                    if (countdown > 0) {
                        showNotification(`Game starting in ${countdown}...`, "Get ready!", "üéÆ");
                    } else {
                        clearInterval(countdownInterval);
                        startGame();
                    }
                }, 1000);
            }
        }

        // ==================== GAME LOGIC ====================
        function startGame() {
            gameState.gameActive = true;
            gameState.round = 1;
            gameState.timeLeft = CONFIG.ROOM.GAME_DURATION;
            gameState.scores = {};
            gameState.combos = {};
            gameState.powerups = {};
            
            // Initialize scores for all players
            Object.keys(gameState.players).forEach(playerId => {
                gameState.scores[playerId] = 0;
                gameState.combos[playerId] = 1;
                gameState.powerups[playerId] = {
                    bomb: { available: true, cooldown: 0 },
                    freeze: { available: true, cooldown: 0 },
                    confuse: { available: true, cooldown: 0 },
                    multiply: { available: true, cooldown: 0 }
                };
            });
            
            // Update room status
            if (gameState.isHost) {
                roomRef.update({ 
                    status: 'playing',
                    round: 1,
                    startedAt: Date.now()
                });
            }
            
            // Switch to game screen
            elements.lobbyScreen.style.display = 'none';
            elements.gameScreen.style.display = 'flex';
            
            // Setup game arena
            setupGameArena();
            
            // Start game timer
            startGameTimer();
            
            // Start spawning targets
            startTargetSpawning();
            
            // Show notification
            showNotification("Game started!", "Tap fast and win!", "üèÅ");
        }

        function setupGameArena() {
            elements.gameArena.innerHTML = '';
            
            const playerIds = Object.keys(gameState.players);
            
            playerIds.forEach((playerId, index) => {
                const isMe = playerId === gameState.playerId;
                const player = gameState.players[playerId];
                const colors = ['#ff4757', '#3742fa', '#2ed573', '#ffa502'];
                
                const playerSide = document.createElement('div');
                playerSide.className = `player-side player${index + 1} ${isMe ? 'my-side' : ''}`;
                playerSide.id = `playerSide_${playerId}`;
                
                playerSide.innerHTML = `
                    <div class="player-header" style="border-color: ${colors[index]}">
                        <div class="player-name">${player.name} ${isMe ? '(You)' : ''}</div>
                        <div class="player-score" style="color: ${colors[index]}" id="score_${playerId}">0</div>
                    </div>
                    <div class="tap-zone" id="tapZone_${playerId}" 
                         ${isMe ? 'onclick="tapMiss(event)"' : ''}>
                    </div>
                    <div class="combo-display" id="combo_${playerId}" style="display: none;">
                        Combo: 1.0x
                    </div>
                `;
                
                elements.gameArena.appendChild(playerSide);
                
                // Add click handler for targets
                if (isMe) {
                    // My side - can tap
                    const tapZone = document.getElementById(`tapZone_${playerId}`);
                    tapZone.addEventListener('click', (e) => {
                        if (e.target.classList.contains('tap-target')) {
                            tapTarget(e.target, playerId);
                        }
                    });
                }
            });
        }

        function startGameTimer() {
            updateTimerDisplay();
            
            gameState.gameTimer = setInterval(() => {
                gameState.timeLeft--;
                updateTimerDisplay();
                
                if (gameState.timeLeft <= 0) {
                    endRound();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            elements.gameTimer.textContent = gameState.timeLeft;
            elements.roundNumber.textContent = `${gameState.round}/${CONFIG.ROOM.ROUNDS}`;
            
            // Update all scores
            Object.keys(gameState.scores).forEach(playerId => {
                const scoreElement = document.getElementById(`score_${playerId}`);
                if (scoreElement) {
                    scoreElement.textContent = gameState.scores[playerId];
                }
            });
            
            // Update combos
            Object.keys(gameState.combos).forEach(playerId => {
                const comboElement = document.getElementById(`combo_${playerId}`);
                if (comboElement) {
                    const combo = gameState.combos[playerId];
                    if (combo > 1.1) {
                        comboElement.style.display = 'block';
                        comboElement.textContent = `Combo: ${combo.toFixed(1)}x`;
                        comboElement.style.background = `rgba(255, ${Math.min(255, combo * 50)}, 0, 0.7)`;
                    } else {
                        comboElement.style.display = 'none';
                    }
                }
            });
        }

        function startTargetSpawning() {
            // Clear any existing timers
            Object.values(gameState.targetTimers).forEach(timer => clearInterval(timer));
            gameState.targetTimers = {};
            
            // Start spawning for each player
            Object.keys(gameState.players).forEach(playerId => {
                gameState.targetTimers[playerId] = setInterval(() => {
                    spawnTargetForPlayer(playerId);
                }, CONFIG.GAMEPLAY.TARGET_SPAWN_RATE);
            });
        }

        function spawnTargetForPlayer(playerId) {
            const tapZone = document.getElementById(`tapZone_${playerId}`);
            if (!tapZone) return;
            
            // Check max targets (max 5 per player)
            const existingTargets = tapZone.querySelectorAll('.tap-target').length;
            if (existingTargets >= 5) return;
            
            const zoneRect = tapZone.getBoundingClientRect();
            
            // Random target type
            const types = CONFIG.TARGETS.TYPES;
            const weights = [60, 25, 10, 5];
            const type = getWeightedRandom(types, weights);
            
            // Random size
            const size = CONFIG.TARGETS.SIZES[Math.floor(Math.random() * CONFIG.TARGETS.SIZES.length)];
            
            // Random position
            const maxX = zoneRect.width - size;
            const maxY = zoneRect.height - size;
            const x = Math.random() * maxX;
            const y = Math.random() * maxY;
            
            // Get emoji
            const emoji = getRandomEmoji(type);
            
            // Create target
            const target = document.createElement('div');
            target.className = `tap-target target-${type}`;
            target.dataset.player = playerId;
            target.dataset.type = type;
            target.dataset.value = getTargetValue(type);
            
            target.style.width = `${size}px`;
            target.style.height = `${size}px`;
            target.style.left = `${x}px`;
            target.style.top = `${y}px`;
            target.style.fontSize = `${size * 0.4}px`;
            target.style.background = getTargetColor(type);
            
            target.textContent = emoji;
            
            // Special animations
            if (type === 'bomb') {
                target.style.animation = 'float 3s infinite ease-in-out, shake 0.5s infinite';
            } else if (type === 'bonus') {
                target.style.animation = 'float 3s infinite ease-in-out, pulse 0.5s infinite';
            } else {
                target.style.animation = 'float 3s infinite ease-in-out';
            }
            
            // Auto-remove after lifetime
            setTimeout(() => {
                if (target.parentNode) {
                    target.remove();
                    
                    // Combo break for missing target
                    if (playerId === gameState.playerId) {
                        gameState.combos[playerId] = Math.max(1, gameState.combos[playerId] - 0.2);
                    }
                }
            }, CONFIG.GAMEPLAY.TARGET_LIFETIME);
            
            tapZone.appendChild(target);
        }

        function tapTarget(target, playerId) {
            if (playerId !== gameState.playerId) return;
            if (!gameState.gameActive) return;
            
            const type = target.dataset.type;
            const baseValue = parseInt(target.dataset.value);
            
            // Calculate score with combo
            const combo = gameState.combos[playerId] || 1;
            const score = Math.round(baseValue * combo);
            
            // Update score
            gameState.scores[playerId] += score;
            
            // Update combo
            if (type !== 'bomb') {
                gameState.combos[playerId] = Math.min(
                    CONFIG.GAMEPLAY.MAX_COMBO,
                    (gameState.combos[playerId] || 1) + CONFIG.GAMEPLAY.COMBO_MULTIPLIER
                );
            } else {
                // Bomb resets combo
                gameState.combos[playerId] = 1;
                showNotification("Bomb!", "Combo reset!", "üí£");
            }
            
            // Create tap effect
            createTapEffect(target, type, score);
            
            // Remove target
            target.remove();
            
            // Update score on server (for real-time sync)
            if (gameState.isHost) {
                updateScoresOnServer();
            }
            
            // Vibrate
            vibrate(30);
        }

        function tapMiss(event) {
            if (!gameState.gameActive) return;
            
            // Only penalize if clicked empty space
            if (!event.target.classList.contains('tap-target')) {
                gameState.combos[gameState.playerId] = Math.max(1, gameState.combos[gameState.playerId] - 0.1);
                createMissEffect(event.clientX, event.clientY);
            }
        }

        function createTapEffect(target, type, score) {
            const effect = document.createElement('div');
            effect.className = 'tap-effect';
            effect.textContent = score > 0 ? `+${score}` : score.toString();
            
            // Color based on type
            const colors = {
                normal: '#2ed573',
                bonus: '#ffa502',
                bomb: '#ff4757',
                mystery: '#8e44ad'
            };
            
            effect.style.color = colors[type] || '#ffffff';
            effect.style.textShadow = `0 0 10px ${colors[type] || '#ffffff'}`;
            
            // Position at target
            const rect = target.getBoundingClientRect();
            effect.style.left = `${rect.left + rect.width / 2}px`;
            effect.style.top = `${rect.top + rect.height / 2}px`;
            
            document.body.appendChild(effect);
            
            setTimeout(() => effect.remove(), 600);
        }

        function createMissEffect(x, y) {
            const effect = document.createElement('div');
            effect.className = 'tap-effect';
            effect.textContent = 'MISS!';
            effect.style.color = '#ff4757';
            effect.style.textShadow = '0 0 10px #ff4757';
            effect.style.left = `${x}px`;
            effect.style.top = `${y}px`;
            
            document.body.appendChild(effect);
            setTimeout(() => effect.remove(), 600);
        }

        // ==================== POWERUPS ====================
        async function usePowerup(type) {
            if (!gameState.gameActive) return;
            
            const powerup = gameState.powerups[gameState.playerId][type];
            if (!powerup.available) return;
            
            // Check if enough score (cost)
            if (gameState.scores[gameState.playerId] < CONFIG.GAMEPLAY.POWERUP_COST) {
                showNotification("Not enough score!", `Need ${CONFIG.GAMEPLAY.POWERUP_COST} points`, "üí∞");
                return;
            }
            
            // Deduct score
            gameState.scores[gameState.playerId] -= CONFIG.GAMEPLAY.POWERUP_COST;
            
            // Set cooldown
            powerup.available = false;
            powerup.cooldown = Date.now() + CONFIG.POWERUPS[type.toUpperCase()].cooldown;
            
            // Update button
            updatePowerupButton(type);
            
            // Send powerup to other players
            const targetPlayers = Object.keys(gameState.players)
                .filter(id => id !== gameState.playerId);
            
            if (targetPlayers.length > 0) {
                await gameRef.child('powerups').push({
                    type: type,
                    sender: gameState.playerId,
                    senderName: gameState.playerName,
                    target: targetPlayers[Math.floor(Math.random() * targetPlayers.length)],
                    timestamp: Date.now()
                });
            }
            
            // Show notification
            const powerupName = CONFIG.POWERUPS[type.toUpperCase()].name;
            showNotification(`${powerupName} used!`, "Sent to random opponent", "‚ö°");
            
            // Update scores
            updateScoresOnServer();
        }

        function applyPowerup(type, senderId) {
            if (!gameState.gameActive) return;
            
            const sender = gameState.players[senderId]?.name || 'Opponent';
            const powerup = CONFIG.POWERUPS[type.toUpperCase()];
            
            showNotification(`${sender} used ${powerup.name}!`, powerup.effect, "‚ö†Ô∏è");
            
            // Apply effect
            switch(type) {
                case 'bomb':
                    // Add bomb targets to my screen
                    for (let i = 0; i < 3; i++) {
                        setTimeout(() => spawnBombTarget(), i * 500);
                    }
                    break;
                    
                case 'freeze':
                    // Freeze my targets temporarily
                    freezeMyTargets(powerup.duration);
                    break;
                    
                case 'confuse':
                    // Make targets move randomly
                    confuseMyTargets(powerup.duration);
                    break;
                    
                case 'multiply':
                    // Double opponent's score temporarily
                    if (gameState.isHost) {
                        multiplyScores(senderId, powerup.duration);
                    }
                    break;
            }
            
            // Visual feedback
            document.body.classList.add('shake');
            setTimeout(() => document.body.classList.remove('shake'), 500);
            vibrate(200);
        }

        function spawnBombTarget() {
            const tapZone = document.getElementById(`tapZone_${gameState.playerId}`);
            if (!tapZone) return;
            
            const zoneRect = tapZone.getBoundingClientRect();
            const size = 60;
            const x = Math.random() * (zoneRect.width - size);
            const y = Math.random() * (zoneRect.height - size);
            
            const bomb = document.createElement('div');
            bomb.className = 'tap-target target-bomb';
            bomb.dataset.player = gameState.playerId;
            bomb.dataset.type = 'bomb';
            bomb.dataset.value = '-30';
            
            bomb.style.width = `${size}px`;
            bomb.style.height = `${size}px`;
            bomb.style.left = `${x}px`;
            bomb.style.top = `${y}px`;
            bomb.style.fontSize = '30px';
            bomb.style.background = 'radial-gradient(circle at 30% 30%, #ff4757, #ff3838)';
            bomb.style.animation = 'float 3s infinite ease-in-out, shake 0.5s infinite';
            bomb.textContent = 'üí£';
            
            tapZone.appendChild(bomb);
            
            setTimeout(() => {
                if (bomb.parentNode) {
                    bomb.remove();
                }
            }, 3000);
        }

        function freezeMyTargets(duration) {
            const tapZone = document.getElementById(`tapZone_${gameState.playerId}`);
            if (!tapZone) return;
            
            const targets = tapZone.querySelectorAll('.tap-target');
            targets.forEach(target => {
                target.style.animation = 'none';
                target.style.opacity = '0.5';
                target.style.filter = 'grayscale(1)';
            });
            
            setTimeout(() => {
                targets.forEach(target => {
                    target.style.animation = '';
                    target.style.opacity = '1';
                    target.style.filter = '';
                });
            }, duration);
        }

        function confuseMyTargets(duration) {
            const tapZone = document.getElementById(`tapZone_${gameState.playerId}`);
            if (!tapZone) return;
            
            const targets = tapZone.querySelectorAll('.tap-target');
            const interval = setInterval(() => {
                targets.forEach(target => {
                    const x = Math.random() * (tapZone.offsetWidth - target.offsetWidth);
                    const y = Math.random() * (tapZone.offsetHeight - target.offsetHeight);
                    target.style.left = `${x}px`;
                    target.style.top = `${y}px`;
                });
            }, 300);
            
            setTimeout(() => clearInterval(interval), duration);
        }

        function multiplyScores(playerId, duration) {
            const originalScore = gameState.scores[playerId];
            
            // Double score temporarily
            gameState.scores[playerId] *= 2;
            
            setTimeout(() => {
                gameState.scores[playerId] = originalScore;
            }, duration);
        }

        function updatePowerupButton(type) {
            const button = document.querySelector(`.powerup-btn.${type}`);
            if (!button) return;
            
            const powerup = gameState.powerups[gameState.playerId][type];
            
            if (powerup.available) {
                button.classList.remove('disabled');
            } else {
                button.classList.add('disabled');
                
                // Show cooldown
                const cooldown = Math.ceil((powerup.cooldown - Date.now()) / 1000);
                button.textContent = cooldown;
                
                // Restore icon after cooldown
                setTimeout(() => {
                    if (powerup.cooldown <= Date.now()) {
                        powerup.available = true;
                        button.classList.remove('disabled');
                        button.textContent = getPowerupIcon(type);
                    }
                }, powerup.cooldown - Date.now());
            }
        }

        function getPowerupIcon(type) {
            const icons = {
                bomb: 'üí£',
                freeze: '‚ùÑÔ∏è',
                confuse: 'üåÄ',
                multiply: '‚úñÔ∏è'
            };
            return icons[type] || '‚ö°';
        }

        // ==================== GAME FLOW ====================
        function endRound() {
            clearInterval(gameState.gameTimer);
            Object.values(gameState.targetTimers).forEach(timer => clearInterval(timer));
            
            // Update round
            gameState.round++;
            
            if (gameState.round <= CONFIG.ROOM.ROUNDS) {
                // Next round
                gameState.timeLeft = CONFIG.ROOM.GAME_DURATION;
                
                showNotification(`Round ${gameState.round - 1} finished!`, 
                               `Round ${gameState.round} starting...`, "üéØ");
                
                setTimeout(() => {
                    startGameTimer();
                    startTargetSpawning();
                }, 3000);
                
            } else {
                // Game finished
                endGame();
            }
        }

        function endGame() {
            gameState.gameActive = false;
            clearInterval(gameState.gameTimer);
            Object.values(gameState.targetTimers).forEach(timer => clearInterval(timer));
            
            // Calculate winner
            const scores = Object.entries(gameState.scores).map(([id, score]) => ({
                id,
                name: gameState.players[id]?.name || 'Unknown',
                score
            }));
            
            scores.sort((a, b) => b.score - a.score);
            
            // Save results
            const results = {
                winner: scores[0].id,
                scores: scores,
                finishedAt: Date.now()
            };
            
            // Update room status
            if (gameState.isHost) {
                roomRef.update({
                    status: 'finished',
                    results: results
                });
            }
            
            // Show results
            showResults(results);
        }

        function showResults(results) {
            elements.gameScreen.style.display = 'none';
            elements.resultsScreen.style.display = 'flex';
            
            const leaderboard = document.getElementById('leaderboard');
            leaderboard.innerHTML = '';
            
            // Update winner badge
            const winnerBadge = document.getElementById('winnerBadge');
            const isWinner = results.winner === gameState.playerId;
            winnerBadge.textContent = isWinner ? 'üèÜ YOU WIN! üèÜ' : 'üéÆ GAME OVER üéÆ';
            winnerBadge.style.background = isWinner ? 
                'linear-gradient(135deg, #ffd700, #ffa502)' :
                'linear-gradient(135deg, #666, #999)';
            
            // Create leaderboard
            results.scores.forEach((player, index) => {
                const isMe = player.id === gameState.playerId;
                
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                if (isMe) item.style.background = 'rgba(255, 215, 0, 0.2)';
                
                item.innerHTML = `
                    <div class="leaderboard-rank">${index + 1}</div>
                    <div class="leaderboard-name">
                        ${player.name} ${isMe ? '(You)' : ''}
                    </div>
                    <div class="leaderboard-score">${player.score}</div>
                `;
                
                leaderboard.appendChild(item);
            });
            
            // Save high score
            const myScore = results.scores.find(p => p.id === gameState.playerId)?.score || 0;
            saveHighScore(myScore);
        }

        // ==================== CHAT SYSTEM ====================
        function toggleChat() {
            const chatBox = document.getElementById('chatBox');
            chatBox.style.display = chatBox.style.display === 'flex' ? 'none' : 'flex';
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add to Firebase
            await chatRef.push({
                senderId: gameState.playerId,
                senderName: gameState.playerName,
                message: message,
                timestamp: Date.now()
            });
            
            // Clear input
            input.value = '';
        }

        function addChatMessage(messageData) {
            const chatMessages = document.getElementById('chatMessages');
            const isMe = messageData.senderId === gameState.playerId;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isMe ? 'own' : ''}`;
            
            messageDiv.innerHTML = `
                <div class="message-sender">${messageData.senderName}</div>
                <div class="message-text">${messageData.message}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ==================== UTILITY FUNCTIONS ====================
        function getWeightedRandom(items, weights) {
            const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
            let random = Math.random() * totalWeight;
            
            for (let i = 0; i < items.length; i++) {
                random -= weights[i];
                if (random <= 0) return items[i];
            }
            
            return items[0];
        }

        function getRandomEmoji(type) {
            const emojis = CONFIG.TARGETS.EMOJIS[type] || ['üéØ'];
            return emojis[Math.floor(Math.random() * emojis.length)];
        }

        function getTargetValue(type) {
            const values = CONFIG.TARGETS.VALUES[type];
            
            if (typeof values === 'object') {
                return Math.floor(Math.random() * (values.max - values.min + 1)) + values.min;
            }
            
            return values || 10;
        }

        function getTargetColor(type) {
            const colors = {
                normal: 'radial-gradient(circle at 30% 30%, #2ed573, #26de81)',
                bonus: 'radial-gradient(circle at 30% 30%, #ffa502, #ff9f1a)',
                bomb: 'radial-gradient(circle at 30% 30%, #ff4757, #ff3838)',
                mystery: 'radial-gradient(circle at 30% 30%, #8e44ad, #9b59b6)'
            };
            
            return colors[type] || colors.normal;
        }

        function updateScoresOnServer() {
            if (gameState.isHost && gameRef) {
                gameRef.child('scores').set(gameState.scores);
            }
        }

        function updateInviteLink() {
            const inviteLink = `${window.location.origin}${window.location.pathname}?room=${gameState.roomCode}`;
            elements.inviteLink.textContent = inviteLink;
        }

        async function shareRoom(method) {
            const inviteLink = `${window.location.origin}${window.location.pathname}?room=${gameState.roomCode}`;
            const shareText = `Join my Tap Battle room! Code: ${gameState.roomCode}`;
            
            switch(method) {
                case 'whatsapp':
                    window.open(`https://wa.me/?text=${encodeURIComponent(shareText + ' ' + inviteLink)}`, '_blank');
                    break;
                    
                case 'copy':
                    navigator.clipboard.writeText(inviteLink).then(() => {
                        showNotification("Link copied!", "Share with friends!", "üìã");
                    });
                    break;
                    
                case 'qr':
                    // Simple QR code using Google Charts API
                    const qrUrl = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(inviteLink)}`;
                    window.open(qrUrl, '_blank');
                    break;
            }
        }

        function toggleInviteBox() {
            elements.inviteBox.classList.toggle('active');
        }

        function showNotification(text, subtext = '', icon = 'üí¨') {
            elements.notificationIcon.textContent = icon;
            elements.notificationText.textContent = `${text} ${subtext}`;
            elements.notification.style.display = 'flex';
            
            setTimeout(() => {
                elements.notification.style.display = 'none';
            }, 3000);
        }

        function vibrate(duration) {
            if (navigator.vibrate) {
                navigator.vibrate(duration);
            }
        }

        function showLoading(text) {
            elements.loadingText.textContent = text;
            elements.loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            elements.loadingOverlay.style.display = 'none';
        }

        async function saveHighScore(score) {
            try {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    const user = JSON.parse(savedUser);
                    if (user && user.uid) {
                        await database.ref('users/' + user.uid).update({
                            battleHighScore: firebase.database.ServerValue.increment(score),
                            battleGamesPlayed: firebase.database.ServerValue.increment(1),
                            lastBattlePlayed: Date.now()
                        });
                    }
                }
            } catch (error) {
                console.log("Error saving high score:", error);
            }
        }

        // ==================== GAME CONTROL FUNCTIONS ====================
        function leaveRoom() {
            if (roomRef) {
                // Remove player from room
                roomRef.child('players/' + gameState.playerId).remove();
                
                // If host leaves and room is empty, delete room
                if (gameState.isHost) {
                    setTimeout(() => {
                        roomRef.once('value').then(snapshot => {
                            const roomData = snapshot.val();
                            if (!roomData || !roomData.players || Object.keys(roomData.players).length === 0) {
                                roomRef.remove();
                            }
                        });
                    }, 1000);
                }
            }
            
            // Go back to lobby
            window.location.href = 'lobby.html';
        }

        function leaveGame() {
            if (confirm("Leave game? This will end the game for everyone.")) {
                if (gameState.isHost) {
                    roomRef.update({ status: 'cancelled' });
                }
                leaveRoom();
            }
        }

        function requestRematch() {
            showNotification("Rematch requested!", "Waiting for other players...", "üîÑ");
            
            if (gameState.isHost) {
                // Reset room for rematch
                roomRef.update({
                    status: 'waiting',
                    players: Object.keys(gameState.players).reduce((acc, playerId) => {
                        acc[playerId] = {
                            ...gameState.players[playerId],
                            ready: false
                        };
                        return acc;
                    }, {})
                });
                
                // Switch back to lobby
                elements.resultsScreen.style.display = 'none';
                elements.lobbyScreen.style.display = 'flex';
                gameState.isReady = false;
                elements.readyBtn.innerHTML = '<span>‚úÖ</span> READY';
            }
        }

        function newGame() {
            leaveRoom();
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }

        function backToLobby() {
            window.location.href = 'lobby.html';
        }

        // ==================== EXPORT FUNCTIONS ====================
        window.toggleReady = toggleReady;
        window.toggleInviteBox = toggleInviteBox;
        window.leaveRoom = leaveRoom;
        window.leaveGame = leaveGame;
        window.shareRoom = shareRoom;
        window.usePowerup = usePowerup;
        window.toggleChat = toggleChat;
        window.sendChatMessage = sendChatMessage;
        window.requestRematch = requestRematch;
        window.newGame = newGame;
        window.backToLobby = backToLobby;
    </script>
</body>
</html>